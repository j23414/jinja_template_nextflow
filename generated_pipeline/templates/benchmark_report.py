#!/usr/bin/env python3

import os
import re
from datetime import datetime
from pathlib import Path

def parse_comparison_file(filepath):
    """Parse comparison statistics"""
    stats = {'sample': '', 'callers': {}}

    with open(filepath) as f:
        content = f.read()

        # Extract sample name
        sample_match = re.search(r'Sample: (\S+)', content)
        if sample_match:
            stats['sample'] = sample_match.group(1)

        # Extract variant counts
        for line in content.split('\n'):
            if ':' in line and 'variants' in line:
                parts = line.split(':')
                caller = parts[0].strip()
                count = parts[1].strip().split()[0]
                stats['callers'][caller] = count

    return stats

# Collect all comparison files
comparison_files = [f for f in os.listdir('.') if f.endswith('_comparison.txt')]
all_stats = [parse_comparison_file(f) for f in sorted(comparison_files)]

# Generate HTML report
html = """
<!DOCTYPE html>
<html>
<head>
    <title>Variant Calling Benchmark Report</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 4px solid #667eea;
            padding-bottom: 15px;
            margin-bottom: 30px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
        }
        .info-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #ecf0f1;
        }
        tr:hover {
            background-color: #f8f9fa;
        }
        .metric {
            display: inline-block;
            background: #ecf0f1;
            padding: 10px 20px;
            border-radius: 5px;
            margin: 5px;
            font-weight: 600;
        }
        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #ecf0f1;
            color: #7f8c8d;
            text-align: center;
        }
        .summary {
            background: #f8f9fa;
            padding: 20px;
            border-left: 4px solid #667eea;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ§¬ Multi-Caller Variant Calling Benchmark</h1>

        <div class="info-box">
            <h3>Pipeline Information</h3>
            <p><strong>Callers Used:</strong> gatk_haplotypecaller, freebayes, bcftools, deepvariant, varscan</p>
            <p><strong>Total Samples:</strong> {num_samples}</p>
            <p><strong>Generated:</strong> {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}</p>
        </div>

        <div class="summary">
            <h3>Summary</h3>
            <p>This report compares variant calling results across multiple tools to help identify:</p>
            <ul>
                <li><strong>Consensus variants:</strong> Called by multiple callers (high confidence)</li>
                <li><strong>Caller-specific variants:</strong> Unique to one tool (may need validation)</li>
                <li><strong>Sensitivity differences:</strong> Which callers detect more variants</li>
            </ul>
        </div>

        <h2>Per-Sample Results</h2>
"""

for stats in all_stats:
    html += f"""
        <h3>Sample: {stats['sample']}</h3>
        <table>
            <thead>
                <tr>
                    <th>Variant Caller</th>
                    <th>Variants Called</th>
                </tr>
            </thead>
            <tbody>
"""
    for caller, count in stats['callers'].items():
        html += f"""
                <tr>
                    <td>{caller}</td>
                    <td>{count}</td>
                </tr>
"""
    html += """
            </tbody>
        </table>
"""

html += """
        <div class="footer">
            <p>Generated by Jinja2-templated Nextflow Pipeline</p>
            <p>For ensemble calling and detailed concordance analysis, see individual sample reports</p>
        </div>
    </div>
</body>
</html>
"""

with open('benchmark_report.html', 'w') as f:
    f.write(html)

print("Benchmark report generated successfully!")